generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String               @id @default(cuid())
  email             String               @unique
  hashedPassword    String?
  createdAt         DateTime             @default(now())
  refreshTokenHash  String?
  firstName         String?
  lastName          String?
  phone             String?
  dob               DateTime?
  phoneVerified     Boolean              @default(false)
  emailVerified     Boolean              @default(false)
  aiUsageLogs       AIUsageLog[]
  apiUsageCounters  ApiUsageCounter[]
  requestedMatches  Match[]              @relation("MatchRequester")
  targetMatches     Match[]              @relation("MatchTarget")
  personEntities    PersonEntity[]
  profiles          PersonalityProfile[]
  uploadSessions    UploadSession[]
  verificationCodes VerificationCode[]

  @@map("users")
}

model VerificationCode {
  id         String              @id @default(cuid())
  userId     String
  channel    VerificationChannel
  purpose    VerificationPurpose
  codeHash   String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime            @default(now())
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, purpose, channel])
  @@index([expiresAt])
  @@map("verification_codes")
}

model UploadSession {
  id            String         @id @default(cuid())
  userId        String
  sourceApp     String
  status        String         @default("READY")
  createdAt     DateTime       @default(now())
  analysisRuns  AnalysisRun[]
  messages      Message[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  uploadedFiles UploadedFile[]

  @@index([userId])
  @@index([sourceApp])
  @@map("upload_sessions")
}

model UploadedFile {
  id              String        @id @default(cuid())
  uploadSessionId String
  storagePath     String
  mime            String
  size            Int
  createdAt       DateTime      @default(now())
  uploadSession   UploadSession @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)

  @@index([uploadSessionId])
  @@map("uploaded_files")
}

model Message {
  id              String        @id @default(cuid())
  uploadSessionId String
  timestamp       DateTime
  sender          String
  text            String
  meta            Json?
  createdAt       DateTime      @default(now())
  uploadSession   UploadSession @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)

  @@index([uploadSessionId])
  @@index([timestamp])
  @@map("messages")
}

model AnalysisRun {
  id              String           @id @default(cuid())
  uploadSessionId String
  status          String           @default("READY")
  model           String?
  createdAt       DateTime         @default(now())
  personEntityId  String?
  personEntity    PersonEntity?    @relation(fields: [personEntityId], references: [id])
  uploadSession   UploadSession    @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)
  insights        Insight[]
  loveGuruThreads LoveGuruThread[]

  @@index([uploadSessionId])
  @@index([personEntityId])
  @@map("analysis_runs")
}

model Insight {
  id            String      @id @default(cuid())
  analysisRunId String
  type          String
  payload       Json
  createdAt     DateTime    @default(now())
  analysisRun   AnalysisRun @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)

  @@index([analysisRunId])
  @@index([type])
  @@map("insights")
}

model LoveGuruThread {
  id            String            @id @default(cuid())
  analysisRunId String
  persona       String
  tone          String
  createdAt     DateTime          @default(now())
  messages      LoveGuruMessage[]
  analysisRun   AnalysisRun       @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)

  @@index([analysisRunId])
  @@map("love_guru_threads")
}

model LoveGuruMessage {
  id        String         @id @default(cuid())
  threadId  String
  role      String
  content   String
  createdAt DateTime       @default(now())
  thread    LoveGuruThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([role])
  @@map("love_guru_messages")
}

model PersonEntity {
  id           String               @id @default(cuid())
  userId       String
  name         String
  type         PersonEntityType
  createdAt    DateTime             @default(now())
  analysisRuns AnalysisRun[]
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  profiles     PersonalityProfile[]

  @@index([userId])
  @@index([type])
  @@map("person_entities")
}

model PersonalityProfile {
  id             String       @id @default(cuid())
  userId         String
  personEntityId String
  profileJSON    Json
  createdAt      DateTime     @default(now())
  personEntity   PersonEntity @relation(fields: [personEntityId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([personEntityId])
  @@map("personality_profiles")
}

model Match {
  id              String   @id @default(cuid())
  requesterUserId String
  targetUserId    String
  score           Int
  breakdown       Json
  filters         Json?
  createdAt       DateTime @default(now())
  requesterUser   User     @relation("MatchRequester", fields: [requesterUserId], references: [id], onDelete: Cascade)
  targetUser      User     @relation("MatchTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([requesterUserId])
  @@index([targetUserId])
  @@index([score])
  @@map("matches")
}

model AIUsageLog {
  id               String   @id @default(cuid())
  userId           String?
  endpoint         String
  provider         String
  model            String?
  operation        String
  inputTokens      Int?
  outputTokens     Int?
  totalTokens      Int?
  estimatedCostUsd Decimal? @db.Decimal(10, 6)
  metadata         Json?
  createdAt        DateTime @default(now())
  user             User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([endpoint])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model ApiUsageCounter {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  day       String
  count     Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint, day])
  @@index([day])
  @@map("api_usage_counters")
}

enum PersonEntityType {
  Friend
  Partner
  Crush
  Family
  Cousin
  Sibling
  Colleague
  Other
}

enum VerificationChannel {
  EMAIL
  PHONE
}

enum VerificationPurpose {
  REGISTER
  PASSWORD_RESET
}
